# Fetch Join

---

> 페치 조인은 JPA에서 연관된 엔티티를 효율적으로 조회하기 위해 사용하는 기능이다.
>
- 즉시 로딩을 강제하여 성능을 최적화하는 데 주로 사용된다.

### ❓언제 가장 많이 쓰일까

---

기본적으로 JPA는 연관된 엔티티를 LAZY 로딩하는 경우가 많다.
이 방식은 실제로 연관된 엔티티가 필요할 때까지 조회를 미루는 방식이라서, 1 + N 문제와 같이 쓸 데 없는 쿼리 호출이 많아질 수 있다.
그렇기 때문에, 이때 페치 조인을 사용하면 한 번의 쿼리로 연관된 엔티티까지 함께 조회할 수 있기에 많이 사용된다.

## ✅ 페치 조인 톡징

---

1. **즉시 로딩**

   페치 조인은 기본적으로 연관된 엔티티를 즉시 로딩하여 지연 로딩 시 발생할 수 있는 1 + N 문제를 해결하는데 유용하다.

2. **쿼리 성능 최적화**

   일반적으로 한 번의 SQL 쿼리로 여러 테이블을 조인하여 필요한 데이터를 모두 조회할 수 있기 때문에 성능이 크게 향상된다.

3. **엔티티 그래프 로드**

   특정 엔티티를 조회할 때 연관된 여러 엔티티들을 한꺼번에 조회할 수 있어서 복잡한 엔티티 구조를 관리하는 데 유용하다.


→ 정리해보면, **한 번의 쿼리**로 연관된 엔티티를 모두 조회할 수 있기에 성능 최적화와 복잡한 엔티티 구조를 효율적으로 관리하는 데 유용하다❗

## ✅ 페치 조인 사용 예시

---

> Member 엔티티와 Review 엔티티가 있을 때,
Member를 조회하면서, 연관된 Review도 한 번에 가져오고 싶다면 아래와 같은 페치 조인을 사용할 수 있다.
>

```java
String jpql = "SELECT m FROM Member m JOIN FETCH m.reviews WHERE m.id = :memberId";
```

- 위 JPQL은 JOIN FETCH 키워드를 사용하여 Member와 연관된 Review를 즉시로딩하도록 한다.
  이렇게 하면 JPA가 Member와 Review를 **한 번의 쿼리로 가져와** N + 1 문제를 방지하게 된다.

## ✅ 페치 조인 사용 시 주의할 점

---

- **컬렉션 페치 조인 시 중복 데이터**

  컬렉션을 페치 조인할 경우, JPA는 기본적으로 `DISTINCT`를 사용하지 않으므로, 결과에 중복된 데이터가 포함될 수 있다. 이때 JPQL에서 `DISTINCT` 키워드를 추가하거나, 애플리케이션 코드에서 중복을 제거해야 할 수 있다.

- **페이징 제한 (**)**

  컬렉션을 페치 조인할 때는 페이징 처리가 제한된다. JPA는 페이징을 위해 데이터베이스의 `LIMIT`와 같은 기능을 사용하는데, 페치 조인을 사용하면 이러한 페이징 처리가 제대로 되지 않을 수 있다.

- **복잡한 연관관계에 대한 성능 고려**

  연관된 엔티티가 많아질수록 페치 조인의 성능이 오히려 저하될 수 있으므로 필요한 관계에만 적용하는 것이 좋다.